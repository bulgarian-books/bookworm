#!/usr/bin/env ruby

require 'forwardable'

require 'reacto'
require 'rest-client'
require 'nokogiri'
# http://www.booksinprint.bg/Publisher/Search

request = Reacto::Trackable.make do |tracker|
  response = RestClient.get 'http://www.booksinprint.bg/Publisher/Search'

  tracker.on_value(response)
  tracker.on_close
end

request = request
  .map { |value| Nokogiri::HTML(value) }
  .flat_map do |value|
    Reacto::Trackable.enumerable(value.css('table.results tr'))
  end
  .select { |value| value.children.first.name == 'td' }
  .map { |value| value.children.first }
  .map do |value|
    uuid = value.xpath('//a/@onclick').first.text
      .scan(/'\/Publisher\/Details\/([^\s]+)'/).flatten.first
    name_code = value.text.strip.scan(/^(.+), код ([\d-]+)$/).flatten

    {
      name: name_code.first,
      code: name_code.last,
      uuid: uuid
    }
  end

request.on(value: ->(v) { p v })
